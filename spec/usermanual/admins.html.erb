<!DOCTYPE html>
<!-- NOTE: doc/usermanual/pages is autogenerated from spec/usermanual -->
<html>
<head>
  <%
  #TODO: get rid of header/layout duplication
  %>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>TMC webapp user manual - admin</title>

  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" type="text/css" href="css/usermanual.css" />
  <link rel="stylesheet" type="text/css" href="lib/shjs/sh_style.css" />

  <script type="text/javascript" src="lib/jquery-1.7.1.min.js"></script>
  <script type="text/javascript" src="lib/shjs/sh_main.min.js"></script>
  <script type="text/javascript" src="lib/shjs/sh_java.min.js"></script>
  <script type="text/javascript" src="js/toc.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      sh_highlightDocument();
      $('#toc').prepend('<h2>Contents</h2>');
      makeToc($('#toc'));
    });
  </script>
</head>
<body>

<%
require 'cgi' # for escapeHTML
%>

<%
  FactoryGirl.create(:admin, :login => 'admin', :password => 'admin')
  ct1 = FactoryGirl.create(:course_template)
  ct2 = FactoryGirl.create(:course_template)
  ct3 = FactoryGirl.create(:course_template)
  organization = FactoryGirl.create :accepted_organization, name: 'Some organization', information: 'Some information'
  course = FactoryGirl.create(:course, organization: organization)
  course.course_template = ct3
  course.save!
%>

  <h1>Admin Manual</h1>

  <div id="toc"></div>

  <p>
    Administrators have exclusive use cases for the TMC webapp, that need to be practiced.
    This page will list these use cases.
  </p>

  <h2>Course templates</h2>

  <p>
    Simplest way to create a course is to copy it from a template. This way teacher won't
    have to create new repositories from which new course will be based off. One of the biggest
    responsibilities for an administrator is managing these templates in TMC webapp.
  </p>

  <p>
    When logged in as administrator, visiting <code>/course_templates</code> will bring you here:
  </p>

<%
   visit '/'
   fill_in 'session_login', :with => 'admin'
   fill_in 'session_password', :with => 'admin'
   click_on 'Sign in'
   visit '/course_templates'
   highlight 'a:contains("New Course template")'
%>
<%= screenshot %>

  <p>
    This page lists all course templates in the database with their relevant information.
    By clicking 'New Course template' you can create a new template through this form:
  </p>

<%
  repo_path = "#{::Rails.root}/tmp/tests/fake_remote_repo"
  create_bare_repo(repo_path)

  click_on 'New Course template'
  fill_in 'course_template_name', with: 'newtemplate'
  fill_in 'course_template_title', with: 'New Template'
  fill_in 'course_template_description', with: 'Short description'
  fill_in 'course_template_material_url', with: 'www.material.com'
  fill_in 'course_template_source_url', with: 'https://www.githug.com/account/course.git.'
  highlight '#course_template_name'
  highlight '#course_template_title'
  highlight '#course_template_source_url'
  highlight '#course_template_git_branch'
%>
<%= screenshot %>
<%
   fill_in 'course_template_source_url', with: repo_path
%>
   <p>
    Highlighted fields are required and can't be left blank. Explanation for each field:
    <ul>
      <li>Courses are shown by <b>Name</b> in IDE plugins (such as NetBeans). Name can't contain whitespaces.</li>
      <li><b>Title</b> is a prettier version of the name that may contain whitespaces, and is shown on webapp pages.</li>
      <li><b>Description</b> is a short piece of text to show when browsing this particular course.</li>
      <li>
        <b>Material url</b> takes user to the online resource that educates and helps the course participant with solving
        the course exercises.
      </li>
      <li>
        <b>Source url</b> is a remote repository from which student will pull exercises as source files.
        When this field is edited, TMC webapp will validate the url by attempting to clone the repository from the url.
        You can find information on how to create a course repository by yourself from this <a href="customcourse.html#starting_from_a_template">guide</a>.
      </li>
      <li>
        <b>Git branch</b> is the name of the branch which combined with source url defines the actual result of the repository cloning.
        Default value is master.
      </li>
      <li>
        After the <b>Expires at</b> date no courses can be cloned from the expired template. Expiration date will not affect courses
        that were cloned before the expiration date.
      </li>
    </ul>
  </p>

  <p>
    All of these fields except for <b>Source url</b>, <b>Git branch</b> and <b>Expires at</b> may be changed by the teacher during the course copying process
    to suit their needs.
  </p>

  <p>After clicking 'Create course template', TMC will show the list of all templates again.</p>

<%
   ct2.hidden = true
   ct2.save!
   click_on 'Create Course template'
   visit '/course_templates'
   expect(page).to have_content('newtemplate')
   highlight 'a:contains("Refresh"):last'
   highlight 'a:contains("hide"):first'
   highlight 'a:contains("Edit"):first'
   highlight 'a:contains("unhide")'
%>
<%= screenshot %>

  <p>
    Whenever any changes to the remote repository are made (new exercises added, exercises removed, etc),
    the course template that uses that repository needs to be refreshed. You can refresh only course templates,
    which already have some courses made from them. After clicking 'Refresh', all courses
    created from the template will be up-to-date. This operation takes some time.
  </p>

  <p>
    Course template default fields may be edited at any time by administrator via link 'Edit'. Expiration date
    may be changed through the same link.
  </p>

  <p>
    Course templates may be hidden instead of being destroyed. Hidden templates will not be available for copying
    as if they were destroyed, even though the template still exists in the database.
  </p>

  <h2>Verifying new organizations</h2>

  <p>
    Another responsibility for administrators is to verify all new created organizations. They can be either verified
    or disabled. Anyone can create a new organization, so they should be verified through careful consideration.
  </p>

  <p>Administrator will see this notice on the front page when there are any unverified new organizations:</p>

<%
  FactoryGirl.create :user, login: 'user', password: 'user'

  click_on 'Sign out'
  fill_in 'session_login', with: 'user'
  fill_in 'session_password', with: 'user'
  click_on 'Sign in'

  visit '/org/new'
  fill_in 'organization[name]', with: 'Helsingin yliopisto'
  fill_in 'organization[information]', with: 'University life'
  fill_in 'organization[slug]', with: 'hy'
  click_button 'Create Organization'
  expect(page).to have_content 'Organization was successfully created.'

  click_on 'Sign out'
  fill_in 'session_login', with: 'admin'
  fill_in 'session_password', with: 'admin'
  click_on 'Sign in'
  visit '/'
  highlight 'a:contains("Show")'
%>
<%= screenshot %>

  <p>
    Clicking 'show' will list all unverified organizations.
  </p>

<%
  click_on 'Show'
  highlight 'a:contains("Verify")'
%>
<%= screenshot %>
<%
  click_on 'Verify'
  expect(page).to have_content 'Organization Helsingin yliopisto is now verified.'
%>
<%= screenshot %>

  <p>
    After clicking 'Verify', organization is fully operational.
  </p>
<%
  visit '/'
%>
<%= screenshot %>

<p>
  Alternatively, after clicking 'Disable', administrator must fill a form to give a reason for disabling.
</p>

<%
  Organization.find_by(slug: 'hy').destroy!
  click_on 'Sign out'
  fill_in 'session_login', with: 'user'
  fill_in 'session_password', with: 'user'
  click_on 'Sign in'

  visit '/org/new'
  fill_in 'organization[name]', with: 'Helsingin yliopisto'
  fill_in 'organization[information]', with: 'University life'
  fill_in 'organization[slug]', with: 'hy'
  click_button 'Create Organization'
  expect(page).to have_content 'Organization was successfully created.'

  click_on 'Sign out'
  fill_in 'session_login', with: 'admin'
  fill_in 'session_password', with: 'admin'
  click_on 'Sign in'
  visit '/'

  click_on 'Show'
  highlight 'a:contains("Disable")'
%>
<%= screenshot %>

<%
   click_on 'Disable'
   fill_in 'organization_disabled_reason', with: 'No such university exists, you can\'t fool me!'
%>
<%= screenshot %>
<%
  click_on 'Disable organization'
  expect(page).to have_content 'Organization Helsingin yliopisto successfully disabled.'
%>
<%= screenshot %>

<p>Disabled organization will not be shown anywhere in the front page.</p>

<%
  visit '/'
%>
<%= screenshot %>

<h2>Monitoring background refreshes</h2>

<p>
  When a new course is made, first real-time refresh is made only partly, without generating available points for exercises. Because of that, full refresh is launched on background. As administrator, the front page shows if there are any ongoing background refreshes, and when they are made. Based on that, you can monitor possible problems, if certain course stays on the refresh list for too long time.
</p>

<%
  course = FactoryGirl.create(:course, organization: organization, initial_refresh_ready: false)
  visit '/'
%>
<%= screenshot %>

</body>
</html>
